<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Venta</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<body>
    <!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">


    <title>Dashborad - CinemaPremier</title>

    <!-- Fuentes para la plantilla-->

    <!-- Fuentes para la plantilla-->
    <link rel="stylesheet" href="../../vendor/butterup-main/butterup.min.css" />
    <link href="../../vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="../../vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Estilos personalizados -->
    <link href="../../css/sb-admin-2.min.css" rel="stylesheet">
    <link href="../css/Dashboard/navbar-styles.css" rel="stylesheet">
    <link href="../css/InventarioDulceria/InventarioDulceria.css" rel="stylesheet">
    <link href="../css/ventaDulceria/ventaDulceria.css" rel="stylesheet">
    <link href="../css/Dashboard/reservaAsientos.css" rel="stylesheet">
    



</head>

<body id="page-top">

    <!-- Protector de la pagina -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Logo de la Sidebar-->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="../../index.html">
                <div class="sidebar-brand-icon rotate-n-0">
                    <img src="../../img/logo-cinema.png" alt="Logo" style="width: 60px; height: 60px;">
                </div>
            </a>


            <!-- Divisor -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item active">
                <a class="nav-link" href="../../index.html">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span></a>
            </li>

            <!-- Divisor -->
            <hr class="sidebar-divider">

            <!-- Encabezado -->
            <div class="sidebar-heading">
                Gestiones
            </div>

            <!-- Nav Item - Contraer menú de Gestion de boletos-->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseBoletos"
                    aria-expanded="true" aria-controls="collapseBoletos">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Gestión de boletos</span>
                </a>
                <div id="collapseBoletos" class="collapse" aria-labelledby="headingBoletos"
                    data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="../gestionDeBoletos/ventaBoletos.html">Venta de boletos</a>
                        <a class="collapse-item" href="../gestionDeBoletos/reservacionBoletos.html">Reservación de
                            boletos</a>
                        <a class="collapse-item" href="../gestionDeBoletos/validacionBoletos.html">Validación de
                            boletos</a>
                    </div>
                </div>
            </li>

            <!-- Nav Item - Contraer menú de Gestion de salas-->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseSalas"
                    aria-expanded="true" aria-controls="collapseSalas">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Gestión de salas</span>
                </a>
                <div id="collapseSalas" class="collapse" aria-labelledby="headingSalas" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="../gestionDeSalas/gestionSalas.html">Gestión</a>
                        <a class="collapse-item" href="../gestionDeSalas/configuracionProyeccin.html">Configuración
                            de <br>proyección</a>
                        <a class="collapse-item" href="../gestionDeSalas/mantenimientoSalas.html">Mantenimiento de
                            salas</a>
                    </div>
                </div>
            </li>

            <!-- Nav Item - Contraer menú de Gestion de Funciones-->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseFunciones"
                    aria-expanded="true" aria-controls="collapseFunciones">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Gestión de funciones</span>
                </a>
                <div id="collapseFunciones" class="collapse" aria-labelledby="headingFunciones"
                    data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="../gestionDeFunciones/programacionDeFunciones.html">Programación
                            de funciones</a>
                        <a class="collapse-item" href="../gestionDeFunciones/gestionFuncionesEspeciales.html">Gestión
                            de funciones <br>especiales y estrenos</a>
                        <a class="collapse-item" href="../gestionDeFunciones/gestionDeFuncionesCanceladas.html">Gestión
                            de funciones
                            <br>canceladas</a>
                    </div>
                </div>
            </li>

            <!-- Nav Item - Contraer menú Gestion de empleados-->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseEmpleados"
                    aria-expanded="true" aria-controls="collapseEmpleados">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Gestión de empleados</span>
                </a>
                <div id="collapseEmpleados" class="collapse" aria-labelledby="headingEmpleados"
                    data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="../gestionDeEmpleados/gestionEmpleados.html">Gestión de
                            empleados</a>
                        <a class="collapse-item" href="../gestionDeEmpleados/gestionRoles.html">Gestión de roles de
                            <br>empleados</a>
                        <a class="collapse-item" href="../gestionDeEmpleados/controlAsistencia.html">Control de
                            asistencia<br>de empleados</a>
                    </div>
                </div>
            </li>

            <!-- Nav Item - Contraer menú de Gestion de clientes-->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseClientes"
                    aria-expanded="true" aria-controls="collapseClientes">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Gestión de clientes</span>
                </a>
                <div id="collapseClientes" class="collapse" aria-labelledby="headingClientes"
                    data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="../gestionDeClientes/gestionClientes.html">Gestión</a>
                        <a class="collapse-item" href="../gestionDeClientes/registroDeClientes.html">Registro de
                            clientes</a>
                        <a class="collapse-item" href="../gestionDeClientes/historialDeComprasDeClientes.html">Historial
                            de compras<br>de
                            clientes</a>
                    </div>
                </div>
            </li>




            <!-- Divisor -->
            <hr class="sidebar-divider">

            <!-- Encabezado -->
            <div class="sidebar-heading">
                Modulos
            </div>

            <!-- Nav Item - Contraer menú de Dulcería -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseDulceria"
                    aria-expanded="true" aria-controls="collapseDulceria">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>Dulcería</span>
                </a>
                <div id="collapseDulceria" class="collapse" aria-labelledby="headingPages"
                data-parent="#accordionSidebar">
                <div id="collapseDulceria" class="collapse" aria-labelledby="headingPages"
                data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" href="../dulceria/inventariDulceria.html">Inventario de dulcería</a>
                    <a class="collapse-item" href="../dulceria/preciosDulceria.html">Gestión de precios</br> de
                        dulcería</a>
                    <a class="collapse-item" href="../dulceria/ventasDulceria.html">Ventas de dulcería</a>
                    <a class="collapse-item" href="../dulceria/historicoDulceria.html">Historico de dulcería</a>

                </div>
            </div>
            </div>
            </li>


            <!-- Nav Item - Contraer menú de Peliculas -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePeliculas"
                    aria-expanded="true" aria-controls="collapsePeliculas">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>Peliculas</span>
                </a>
                <div id="collapsePeliculas" class="collapse" aria-labelledby="headingPages"
                    data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="../../index.html">Login</a>
                        <a class="collapse-item" href="../../index.html">Register</a>
                    </div>
                </div>
            </li>


            <!-- Nav Item - Contraer menú de Reportes -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseReportes"
                    aria-expanded="true" aria-controls="collapseReportes">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>Reportes</span>
                </a>
                <div id="collapseReportes" class="collapse" aria-labelledby="headingPages"
                    data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="../reportes/reportesDeVentas.html">Reportes de ventas</a>
                        <a class="collapse-item" href="../reportes/reportesDeVentas.html">Reportes de algo</a>
                    </div>
                </div>
            </li>

        </ul>
        <!-- Fin de la Sidebar -->




























        <!-- Contenido del Dashboard -->
        <div class="container-fluid">
    <div class="form-neon">
        <form id="venta-form" onsubmit="enviarVenta(event)">
            <div class="row">
                <!-- Sección de productos -->
                <div class="col-12 col-lg-9">
                    <div class="container-fluid">
                        <h2>Venta Dulcería</h2>
                        <button type="button" class="btn btn-primary" onclick="agregarFilaProducto()">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                        <div class="table-responsive mt-3">
                            <table class="table table-hover table-bordered table-sm" id="productos-table">
                                <thead class="bg-info">
                                    <tr class="text-center">
                                        <th>#</th>
                                        <th>Producto</th>
                                        <th>Precio</th>
                                        <th>Cantidad</th>
                                        <th>Eliminar</th>
                                    </tr>
                                </thead>
                                <tbody id="productos-table-body">
                                    <tr class="text-center">
                                        <td colspan="5">No hay productos agregados</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sección de datos de la venta -->
                <div class="col-12 col-lg-3">
                    <h3 class="text-center text-uppercase">Datos de la venta</h3>
                    <hr>

                    <div class="form-group">
                        <label for="venta_cliente">Cliente</label>
                        <input list="clientes-list" class="form-control" id="venta_cliente" placeholder="Seleccione un cliente" required>
                        <datalist id="clientes-list">
                        </datalist>
                    </div>

                    <ul class="list-group list-unstyled">
                        <li class="list-group-item d-flex justify-content-between align-items-center font-weight-bold">
                            Total
                            <span class="badge badge-pill" id="venta_total">$0.00</span>
                        </li>
                    </ul>
                    <button type="submit" class="btn btn-success btn-block mt-3">
                        <i class="fas fa-save"></i> Registrar Venta
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let productosDisponibles = [];

    document.addEventListener('DOMContentLoaded', async () => {
        await cargarClientes();
        await cargarProductos();
    });

    async function cargarClientes() {
        try {
            const response = await fetch('http://162.214.153.239:5010/api/clientes/get_clients');
            if (!response.ok) throw new Error('Error al obtener los clientes');
            const clientes = await response.json();
            const datalist = document.getElementById('clientes-list');
            datalist.innerHTML = '';
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id_cliente;
                datalist.appendChild(option);
            });
        } catch (error) {
            console.error('Error al cargar los clientes:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudieron cargar los clientes. Por favor, intente más tarde.',
            });
        }
    }

    async function cargarProductos() {
        try {
            const response = await fetch('https://inventariodulceria-fehwdtavgnbfg4a7.canadacentral-01.azurewebsites.net//productos/api');
            if (!response.ok) throw new Error('Error al obtener los productos');

            const jsonResponse = await response.json();
            console.log('Respuesta de la API de productos:', jsonResponse);

            productosDisponibles = Array.isArray(jsonResponse) ? jsonResponse : jsonResponse.data || [];

            if (!Array.isArray(productosDisponibles)) {
                throw new Error('La respuesta de productos no es un arreglo válido');
            }
        } catch (error) {
            console.error('Error al cargar los productos:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudieron cargar los productos. Por favor, intente más tarde.',
            });
        }
    }

    function agregarFilaProducto() {
        const tableBody = document.getElementById('productos-table-body');
        const rowCount = tableBody.rows.length;

        const row = document.createElement('tr');
        row.classList.add('text-center');

        row.innerHTML = `
            <td>${rowCount + 1}</td>
            <td>
                <select class="form-control producto-nombre" onchange="actualizarPrecio(this)" required>
                    <option value="">Seleccione un producto</option>
                    ${productosDisponibles
                        .map(
                            (producto) => `
                        <option value="${producto.idProducto}" data-nombre="${producto.nombre}" data-precio="${producto.precioVenta}" data-peso="${producto.pesoCantidad}">
                            ${producto.nombre} (${producto.pesoCantidad})
                        </option>`
                        )
                        .join('')}
                </select>
            </td>
            <td>
                <input type="number" class="form-control producto-precio" readonly>
            </td>
            <td>
                <input type="number" class="form-control producto-cantidad" value="1" min="1" onchange="actualizarTotal()" required>
            </td>
            <td>
                <button type="button" class="btn btn-danger" onclick="eliminarFila(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(row);
        actualizarTotal();
    }

    function actualizarPrecio(selectElement) {
        const selectedOption = selectElement.selectedOptions[0];
        const precioInput = selectElement.closest('tr').querySelector('.producto-precio');
        const cantidadInput = selectElement.closest('tr').querySelector('.producto-cantidad');

        if (selectedOption) {
            const precio = parseFloat(selectedOption.getAttribute('data-precio')) || 0;
            precioInput.value = precio.toFixed(2); // Actualiza el precio del producto seleccionado

            // Si la cantidad está vacía o no es válida, establecerla en 1
            if (!cantidadInput.value || parseInt(cantidadInput.value) <= 0) {
                cantidadInput.value = 1;
            }
        } else {
            precioInput.value = ''; // Limpia el precio si no hay selección
        }

        actualizarTotal(); // Llama al recalculador del total
    }

    function actualizarTotal() {
        let total = 0;

        // Recorre todas las filas de productos en la tabla
        document.querySelectorAll('#productos-table-body tr').forEach((row) => {
            const precio = parseFloat(row.querySelector('.producto-precio')?.value) || 0;
            const cantidad = parseInt(row.querySelector('.producto-cantidad')?.value) || 0;

            // Calcula el subtotal de la fila y lo suma al total
            total += precio * cantidad;
        });

        // Actualiza el total en la interfaz
        document.getElementById('venta_total').innerText = `$${total.toFixed(2)}`;
    }

    function eliminarFila(button) {
        const row = button.closest('tr');
        row.remove();
        actualizarTotal();
    }

    async function enviarVenta(event) {
        event.preventDefault();

        const cliente = document.getElementById('venta_cliente').value;
        const productos = Array.from(document.querySelectorAll('.producto-nombre'))
            .map(select => select.selectedOptions[0]) // Obtenemos las opciones seleccionadas
            .filter(option => option !== null); // Filtramos solo las opciones seleccionadas

        // Validar que se haya seleccionado al menos un producto
        if (!cliente || productos.length === 0) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor complete todos los campos antes de enviar.',
            });
            return;
        }

        // Obtener los nombres de los productos seleccionados
        const nombresProductos = productos.map(option => option.getAttribute('data-nombre'));

        // Calcular el total de la venta
        let total = 0;
        const precios = document.querySelectorAll('.producto-precio');
        precios.forEach(precioInput => {
            total += parseFloat(precioInput.value) || 0;
        });

        if (total <= 0) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'El total de la venta debe ser mayor que cero.',
            });
            return;
        }

        // Datos a enviar, incluyendo los nombres de los productos seleccionados
        const datosVenta = {
            cliente,
            nombre: nombresProductos, // Enviar los nombres de los productos
            total
        };

        console.log('Datos a enviar:', JSON.stringify(datosVenta));

        try {
            const response = await fetch('https://cinemapremier-venta-fxfrcegeb3b6gdb5.mexicocentral-01.azurewebsites.net/ventas/nuevo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datosVenta),
            });

            const responseText = await response.text();

            if (response.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Venta registrada correctamente',
                    text: 'Venta realizada con éxito.',
                });

                document.getElementById('venta-form').reset();
                actualizarTotal();
                document.getElementById('productos-table-body').innerHTML = '<tr class="text-center"><td colspan="4">No hay productos agregados</td></tr>';
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error al registrar la venta',
                    text: responseText,
                });
            }
        } catch (error) {
            console.error('Error al realizar la solicitud:', error);
            Swal.fire({
                icon: 'error',
                title: 'Ocurrió un error',
                text: 'Hubo un error al registrar la venta: ' + error.message,
            });
        }
    }
</script>




        














































                <!-- Fin del contenedor -->



            </div>
            <!-- Fin del contenido principal -->

            <!-- Footer -->
           
            <!-- Fin del Footer -->

        </div>
        <!-- Fin del contenido -->

    </div>
    <!-- End of Page Wrapper -->





    <!-- Bootstrap core JavaScript-->
    <script src="../../vendor/jquery/jquery.min.js"></script>
    <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="../../vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="../../js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="../../vendor/chart.js/Chart.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="../../js/demo/chart-area-demo.js"></script>
    <script src="../../js/demo/chart-pie-demo.js"></script>

</body>

</html>
    
    
    
</body>

</html>
